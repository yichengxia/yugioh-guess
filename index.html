<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Guess Yu-Gi-Oh! Card</title>
  <style>
    .background-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url("other-images/wallpaper.jpg");
      background-size: cover;
      background-position: center;
      opacity: 0.2; /* üîç adjust transparency here (0 = fully transparent, 1 = fully visible) */
      z-index: -1;
    }

    body {
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f8f9fa; /* light background */
      overflow: hidden; /* Disable scroll */
      height: 100%;
      position: fixed;
      width: 100%;
    }

    html {
      overscroll-behavior: none;
      overflow: hidden; /* Disable scroll */
      height: 100%;
      position: fixed;
      width: 100%;
    }

    h1 {
      text-align: center;
      margin-top: 20px;
      color: #343a40; /* dark text */
    }

    .input-container {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 16px 0;
    }

    /* Fancy input field */
    #guessInput {
      width: 300px;
      padding: 10px 14px;
      font-size: 16px;
      border-radius: 24px;
      border: 2px solid #007bff;
      outline: none;
      box-shadow: 0 3px 6px rgba(0,0,0,0.08);
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    #guessInput:focus {
      border-color: #0056b3;
      box-shadow: 0 4px 10px rgba(0, 123, 255, 0.2);
    }

    /* Common button base */
    button {
      padding: 10px 18px;
      font-size: 16px;
      border-radius: 24px;
      cursor: pointer;
      margin: 8px 6px;
      transition: all 0.25s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border: none;
    }

    /* Submit Guess button: primary color */
    button:nth-of-type(1) {
      background-color: #007bff;
      color: white;
    }

    button:nth-of-type(1):hover {
      background-color: #0056b3;
      transform: translateY(-2px);
      box-shadow: 0 6px 10px rgba(0,0,0,0.15);
    }

    /* New Game button: lighter style */
    button:nth-of-type(2) {
      background-color: #e2e6ea;
      color: #333;
    }

    button:nth-of-type(2):hover {
      background-color: #d6d8db;
      transform: translateY(-2px);
      box-shadow: 0 6px 10px rgba(0,0,0,0.12);
    }

    .result-row {
      display: grid;
      grid-template-columns:
        minmax(160px, 3fr)  /* CardName */
        repeat(3, minmax(80px, 1fr)) /* CardType, Attribute, Property */
        minmax(120px, 1.5fr) /* Types */
        repeat(5, minmax(40px, 1fr)) /* Level, ATK, DEF, Link, Pendulum */
      ;
      gap: 6px;
      margin-top: 6px;
      margin-left: 50px;
      margin-right: 50px;
    }

    .field {
      display: flex;               /* make it a flex box */
      align-items: center;         /* vertical center */
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .correct {
      background-color: #d4edda;
      color: #155724;
      border-color: #c3e6cb;
    }

    .incorrect {
      background-color: #f5b5b5;    /* darker red-pink */
      color: #721c24;
      border-color: #f1a1a1;
    }

    .card-thumbnail {
      height: 32px;
      cursor: zoom-in;
      border: 1px solid #aaa;
      border-radius: 4px;
    }

    .zoom-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .zoom-wrapper img {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      cursor: default; /* no pointer on image */
    }

    .hidden {
      display: none;
    }

    .credits {
      position: fixed;
      bottom: 10px;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 14px;
      color: #555;
      background-color: rgba(255, 255, 255, 0.7); /* optional translucent bg */
      padding: 6px 0;
      z-index: 10;
    }

    .credits a {
      color: #007bff;
      text-decoration: none;
      margin: 0 1px;
    }

    .credits a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="background-overlay"></div>

  <h1>Guess Yu-Gi-Oh! Card</h1>
  
  <div class="input-container">
    <p id="triesLeft">Enter the card name (you have 7 tries):</p>
    <input list="cardList" id="guessInput" placeholder="Enter card name">
    <button onclick="submitGuess()">Submit Guess</button>
    <button onclick="confirmNewGame()">New Game</button>
  </div>

  <datalist id="cardList"></datalist>
  <div id="results" class="result-table">
    <div id="results"></div>
  </div>

  <script>
    const MAX_TRIES = 7;
    let cards = [];
    let answer = null;
    let tries = 0;

    const FIELD_NAMES = [
      "CardName", "id", "CardType", "Attribute", "Property", "Types",
      "Level", "ATK", "DEF", "Link", "PendulumScale", "Description"
    ];

    // DISPLAY_FIELDS: visible fields in table (excluding "id" and "Description")
    const DISPLAY_FIELDS = [
      "CardName", "CardType", "Attribute", "Property", "Types",
      "Level", "ATK", "DEF", "Link", "PendulumScale"
    ];

    const FIELDS_TO_CHECK = [
      "CardType", "Attribute", "Property", "Types",
      "Level", "ATK", "DEF", "Link", "PendulumScale"
    ];

    // Load and parse CSV
    async function loadCards() {
      const res = await fetch('cards.csv');
      const csvText = await res.text();

      const parsed = Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
      });

      cards = parsed.data.map(card => {
        const cleanedCard = {};
        for (let key in card) {
          // Replace HTML-escaped apostrophes
          if (typeof card[key] === 'string') {
            cleanedCard[key] = card[key].replace(/&#039;/g, "'").trim();
          } else {
            cleanedCard[key] = card[key];
          }
        }
        return cleanedCard;
      });

      answer = cards[Math.floor(Math.random() * cards.length)];
      populateDatalist(cards);
      createTableHeader();
      document.getElementById("guessInput").addEventListener("input", function (e) {
        const val = e.target.value.trim();
        const input = e.target;
        
        if (val.length === 0) {
          input.removeAttribute("list");  // disables suggestions
        } else {
          input.setAttribute("list", "cardList");  // re-enable
        }
      });

      document.getElementById("guessInput").addEventListener("change", function (e) {
        e.target.removeAttribute("list");
      });

      document.getElementById("guessInput").addEventListener("mousedown", function (e) {
        e.target.removeAttribute("list");
      });

      // Prevent showing list on focus (click)
      document.getElementById("guessInput").addEventListener("focus", function (e) {
        e.target.removeAttribute("list");
      });

      let zoomLevel = 1;
      document.getElementById("zoomedImage").addEventListener("wheel", function (e) {
        e.preventDefault();
        zoomLevel += e.deltaY > 0 ? -0.1 : 0.1;
        zoomLevel = Math.max(0.5, Math.min(3, zoomLevel));
        this.style.transform = `scale(${zoomLevel})`;
      });
      document.getElementById("zoomModal").addEventListener("click", function (e) {
        // Only close if user clicked outside the image
        if (!e.target.closest(".zoom-wrapper")) {
          this.classList.add("hidden");
        }
      });

      console.log("Answer Card:", answer);
    }

    function populateDatalist(data) {
      const list = document.getElementById('cardList');
      data.forEach(card => {
        const option = document.createElement('option');
        option.value = card.CardName;
        list.appendChild(option);
      });

      updateTriesLeft();
    }

    function createTableHeader() {
      const header = document.createElement('div');
      header.className = 'result-row';

      DISPLAY_FIELDS.forEach(field => {
        const span = document.createElement('span');
        span.className = 'field';
        span.style.fontWeight = 'bold';
        span.textContent = field === "PendulumScale" ? "Pendulum" : field;
        header.appendChild(span);
      });

      document.getElementById('results').appendChild(header);
    }

    function submitGuess() {
      if (tries >= MAX_TRIES) return;

      const input = document.getElementById('guessInput');
      const guessName = input.value.trim();
      const guessedCard = cards.find(c => c.CardName.toLowerCase() === guessName.toLowerCase());

      if (!guessedCard) {
        alert("Card not found!");
        return;
      }

      displayResult(guessedCard);
      tries++;
      updateTriesLeft();
      if (tries >= MAX_TRIES || isCorrect(guessedCard)) {
        alert(isCorrect(guessedCard) ? "üéâ Correct!" : "‚ùå Out of guesses! The answer was: " + answer.CardName);
        // If incorrect, display the answer
        if (!isCorrect(guessedCard)) {
          displayResult(answer);
        }
      }

      input.value = "";
    }

    function isCorrect(card) {
      return Object.keys(answer).every(key => card[key] === answer[key]);
    }

    function displayResult(guess) {
      const row = document.createElement('div');
      row.className = 'result-row';

      DISPLAY_FIELDS.forEach(field => {
        const span = document.createElement('span');
        span.className = 'field';

        let isCorrect = true;
        let displayValue = guess[field];

        if (field === "CardName") {
          const wrapper = document.createElement("div");
          wrapper.style.display = "flex";
          wrapper.style.alignItems = "center";
          wrapper.style.gap = "8px";

          const image = document.createElement("img");
          const id = guess.id?.toString().replace(/^0+/, '');
          image.src = `card-images/${id}.png`;
          image.onerror = () => {
            image.src = 'card-images/Back-EN.png';
          };
          image.className = "card-thumbnail";
          image.alt = guess[field];
          image.dataset.full = image.src;

          image.addEventListener("click", () => toggleZoom(image));

          const nameSpan = document.createElement("span");
          nameSpan.textContent = displayValue ?? "-";

          wrapper.appendChild(image);
          wrapper.appendChild(nameSpan);
          span.appendChild(wrapper);
        } else {
          // Normalize value
          if (["Attribute", "Property", "Types"].includes(field) && displayValue === "NULL") {
            displayValue = "-";
          }
          if (["Level", "ATK", "DEF", "Link", "PendulumScale"].includes(field)
              && (displayValue === "-1" || displayValue === -1)) {
            displayValue = "-";
          }

          span.textContent = displayValue ?? "-";
        }

        // Check correctness
        if (FIELDS_TO_CHECK.includes(field)) {
          const isMonster = guess.CardType === "Monster" && answer.CardType === "Monster";
          const isNumeric = ["Level", "ATK", "DEF", "Link", "PendulumScale"].includes(field);

          const val1 = parseInt(guess[field]);
          const val2 = parseInt(answer[field]);

          const isEqual = guess[field] === answer[field];
          isCorrect = isEqual;

          if (isEqual) {
            span.classList.add("correct");
          } else {
            span.classList.add("incorrect");

            // Add arrow hint if both are Monster and field is numeric
            if (isMonster && isNumeric && !isNaN(val1) && !isNaN(val2)) {
              const arrow = document.createElement("span");
              arrow.style.marginLeft = "4px";
              arrow.style.fontWeight = "bold";
              arrow.style.color = "#721c24";
              arrow.textContent = val1 < val2 ? "‚Üë" : "‚Üì";
              span.appendChild(arrow);
            }
          }
        }

        row.appendChild(span);
      });

      document.getElementById('results').appendChild(row);
    }

    function toggleZoom(imgElement) {
      const modal = document.getElementById("zoomModal");
      const zoomedImage = document.getElementById("zoomedImage");

      if (modal.classList.contains("hidden")) {
        zoomedImage.src = imgElement.dataset.full;
        modal.classList.remove("hidden");
        zoomLevel = 1;
        zoomedImage.style.transform = "scale(1)";
      } else {
        modal.classList.add("hidden");
      }
    }

    function updateTriesLeft() {
      const left = MAX_TRIES - tries;
      document.getElementById("triesLeft").textContent = `Enter the card name (you have ${left} ${left < 2 ? 'try):' : 'tries):'}`;
    }

    function confirmNewGame() {
      if (confirm("Are you sure you want to start a new game?")) {
        startNewGame();
      }
    }

    function startNewGame() {
      tries = 0;
      answer = cards[Math.floor(Math.random() * cards.length)];

      // Clear results
      const results = document.getElementById('results');
      results.innerHTML = '';  // Remove all previous guess rows

      createTableHeader();     // Add back header row
      updateTriesLeft();       // Reset tries counter
      document.getElementById("guessInput").value = "";  // Clear input

      console.log("New Answer:", answer);  // Debug log
    }

    loadCards();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <div id="zoomModal" class="zoom-modal hidden">
    <div class="zoom-wrapper">
      <img id="zoomedImage" src="" alt="">
    </div>
  </div>

  <footer class="credits">
    ¬© 2025 
    Designed by <a href="https://github.com/yichengxia/yugioh-guess">YC</a> | 
    Resources from <a href="https://github.com/Wildric-Auric/YuGiOh-Database">YuGiOh-Database</a> | 
    Inspired by <a href="https://github.com/QuantAskk/pokemonle">pokemonle</a> & Wordle
  </footer>
</body>
</html>
